<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pedidos - P&C Candys</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        header {
            background-color: #f44336;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #d32f2f;
            position: relative;
        }
        .logo {
            font-size: 4vw;
            font-weight: bold;
            color: white;
            margin-left: 10px;
        }
        .page-space {
            margin-right: 10px;
        }
        .menu-toggle {
            font-size: 4vw;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: none;
            margin-right: 10px;
        }
        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
        }
        .nav-menu li {
            margin-left: 2vw;
        }
        .nav-menu a {
            color: white;
            text-decoration: none;
            font-size: 3vw;
        }
        .nav-menu.active {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #f44336;
            padding: 10px 0;
        }
        .order-section {
            padding: 5vw;
            text-align: center;
        }
        .order-section h1 {
            color: #1e88e5;
            font-size: 5vw;
            margin-bottom: 2vw;
        }
        .order-form {
            max-width: 90vw;
            margin: 0 auto;
            background-color: white;
            padding: 3vw;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .order-form label {
            display: block;
            font-size: 2.5vw;
            margin-bottom: 1vw;
            color: #1e88e5;
            text-align: left;
        }
        .order-form input,
        .order-form select {
            width: 90%;
            padding: 1.5vw;
            margin-bottom: 2vw;
            font-size: 2.5vw;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #map {
            width: 90%;
            height: 400px;
            margin: 2vw auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .order-form button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 2vw 4vw;
            border-radius: 5px;
            font-size: 2.5vw;
            cursor: pointer;
        }
        .order-form button:hover {
            background-color: #45a049;
        }
        #orderItems {
            margin: 2vw 0;
            text-align: left;
            max-width: 90vw;
            margin-left: auto;
            margin-right: auto;
        }
        #orderItems p {
            font-size: 2.5vw;
            margin: 1vw 0;
        }
        #orderItems ul {
            padding-left: 1.5em;
        }
        #orderItems li {
            margin-bottom: 1vw;
            font-size: 2.5vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #orderItems li button {
            background: #f44336;
            border: none;
            color: white;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            font-size: 2vw;
            cursor: pointer;
            line-height: 1;
        }
        #orderSummary {
            margin-top: 3vw;
            background-color: #f9f9f9;
            padding: 2vw;
            border-radius: 5px;
            display: none;
        }
        #orderSummary p {
            font-size: 2.5vw;
            margin: 1vw 0;
        }
        footer {
            background-color: #1976d2;
            color: white;
            padding: 3vw;
            text-align: center;
            margin-top: 5vw;
            margin-bottom: 0;
        }
        .social-icons a {
            color: white;
            margin: 0 2vw;
            text-decoration: none;
            font-size: 4vw;
        }
        @media (max-width: 767px) {
            .menu-toggle {
                display: block;
            }
            .nav-menu {
                display: none;
            }
            .nav-menu li {
                margin: 2vw 0;
            }
            #map {
                height: 200px;
            }
        }
        @media (min-width: 768px) {
            .logo {
                font-size: 24px;
            }
            .page-space {
                font-size: 16px;
            }
            .order-section h1 {
                font-size: 32px;
            }
            .order-form label {
                font-size: 16px;
            }
            .order-form input,
            .order-form select {
                font-size: 14px;
                padding: 8px;
            }
            .order-form button {
                font-size: 14px;
                padding: 10px 20px;
            }
            #orderItems p,
            #orderSummary p {
                font-size: 14px;
            }
            #map {
                height: 400px;
            }
            .nav-menu a {
                font-size: 16px;
            }
            .social-icons a {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">üç≠ P&C Candys</div>
        <div class="page-space"></div>
        <button class="menu-toggle">‚ò∞</button>
        <ul class="nav-menu">
            <li><a href="index.html">Inicio</a></li>
            <li><a href="bolsa_de_gomitas.html">Bolsa de Gomitas</a></li>
            <li><a href="charolas.html">Charolas</a></li>
            <li><a href="mini_hot_cakes.html">Mini Hot Cakes</a></li>
            <li><a href="fresas_con_crema.html">Fresas con Crema</a></li>
            <li><a href="extras.html">Extras</a></li>
            <li><a href="pedidos.html">Pedidos</a></li>
        </ul>
    </header>

    <section class="order-section">
        <h1>Realiza tu Pedido</h1>
        <div class="order-form">
            <div id="orderItems">
                <h3>Productos Seleccionados:</h3>
                <p id="orderList">No has seleccionado productos a√∫n.</p>
            </div>
            <label for="orderDate">Pedido programado para:</label>
            <input type="date" id="orderDate" required />
            <label for="address">Entrega en:</label>
            <input type="text" id="address" placeholder="Direcci√≥n" required />
            <label>Selecciona tu ubicaci√≥n:</label>
            <button type="button" onclick="getLocation()">Usar mi ubicaci√≥n actual</button>
            <div id="map"></div>
            <input type="hidden" id="latitud" />
            <input type="hidden" id="longitud" />
            <label for="clientName">Nombre:</label>
            <input type="text" id="clientName" placeholder="Tu nombre" required />
            <label for="phone">N√∫mero de tel√©fono:</label>
            <input type="tel" id="phone" placeholder="Ej. 555-123-4567" required />
            <label for="paymentMethod">M√©todo de pago:</label>
            <select id="paymentMethod" required>
                <option value="">Selecciona</option>
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="transferencia">Transferencia</option>
            </select>
            <button type="button" onclick="submitOrder()">Enviar Pedido</button>
        </div>
        <div id="orderSummary"></div>
    </section>

    <footer>
        <h3>Redes Sociales</h3>
        <div class="social-icons">
            <a href="https://facebook.com/PyCCandys" target="_blank">Facebook</a>
            <a href="https://instagram.com/PyCCandys" target="_blank">Instagram</a>
            <a href="https://wa.me/524481012425" target="_blank">WhatsApp</a>
            <a href="https://tiktok.com/@PyCCandys" target="_blank">TikTok</a>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let map;
        let marker;

        window.onload = function () {
            updateOrderList();
            initMap();
        };

        // Actualiza la lista visible de productos seleccionados
        function updateOrderList() {
            const orderList = document.getElementById('orderList');
            const orderItemsDiv = document.getElementById('orderItems');
            if (orders.length > 0) {
                orderItemsDiv.style.display = 'block';
                // Construir la lista con botones para eliminar
                let ul = document.createElement('ul');
                orders.forEach((item, index) => {
                    let li = document.createElement('li');
                    // Texto del producto
                    let text = `${item.name}`;
                    if (item.variety) text += ` (${item.variety})`;
                    if (item.type) text += ` [${item.type}]`;
                    text += ` - $${item.price}`;
                    li.textContent = text;

                    // Bot√≥n eliminar
                    let btnDelete = document.createElement('button');
                    btnDelete.textContent = '√ó';
                    btnDelete.title = 'Eliminar producto';
                    btnDelete.onclick = () => {
                        removeOrderItem(index);
                    };

                    li.appendChild(btnDelete);
                    ul.appendChild(li);
                });

                // Detalles agrupados (charola + gomitas etc)
                const hasGomitas = orders.some(item => item.category === 'gomitas');
                const hasCharola = orders.some(item => item.category === 'charola');
                const hasMiniHotcakes = orders.some(item => item.category === 'mini_hotcakes');
                const hasFresas = orders.some(item => item.category === 'fresas');
                const hasExtras = orders.some(item => item.category === 'extras');

                let productDetails = '';

                if (hasCharola) {
                    const charolaItem = orders.find(item => item.category === 'charola');
                    const charolaType = charolaItem?.type || charolaItem?.variety || 'No especificado';
                    const gomitasType = orders.find(item => item.category === 'gomitas')?.variety || 'No especificado';

                    productDetails += `Charola (${charolaType}, Gomitas: ${gomitasType})`;
                } else if (hasGomitas && !hasCharola) {
                    const gomitasType = orders.find(item => item.category === 'gomitas')?.variety || 'No especificado';
                    productDetails += `Bolsa de gomitas (${gomitasType})`;
                }
                if (hasMiniHotcakes) {
                    productDetails += `${productDetails ? '\n' : ''}Mini Hotcakes`;
                }
                if (hasFresas) {
                    productDetails += `${productDetails ? '\n' : ''}Fresas con crema`;
                }
                if (hasExtras) {
                    const extras = orders.filter(item => item.category === 'extras').map(item => item.name).join(', ');
                    productDetails += `${productDetails ? '\n' : ''}Extras: ${extras}`;
                }

                orderList.innerHTML = ''; // Limpiar texto simple
                orderList.appendChild(ul);

                // Mostrar detalles agrupados debajo en texto simple
                let detailsDiv = document.getElementById('detailsGrouped');
                if (!detailsDiv) {
                    detailsDiv = document.createElement('p');
                    detailsDiv.id = 'detailsGrouped';
                    detailsDiv.style.whiteSpace = 'pre-line'; // Para que respete saltos de l√≠nea
                    orderList.parentNode.appendChild(detailsDiv);
                }
                detailsDiv.textContent = productDetails;
            } else {
                orderItemsDiv.style.display = 'block';
                orderList.textContent = 'No has seleccionado productos a√∫n.';
                // Remover detalles agrupados si existen
                let detailsDiv = document.getElementById('detailsGrouped');
                if (detailsDiv) detailsDiv.remove();
            }
        }

        // Eliminar producto seleccionado por √≠ndice
        function removeOrderItem(index) {
            orders.splice(index, 1);
            localStorage.setItem('orders', JSON.stringify(orders));
            updateOrderList();
        }

        // Inicializar mapa con Leaflet
        function initMap() {
            const latInput = document.getElementById('latitud');
            const lngInput = document.getElementById('longitud');

            let lat = 19.4326;
            let lng = -99.1332;

            if (latInput.value && lngInput.value) {
                lat = parseFloat(latInput.value);
                lng = parseFloat(lngInput.value);
            }

            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution:
                    '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(map);

            marker = L.marker([lat, lng], { draggable: true }).addTo(map);

            marker.on('dragend', function (e) {
                const latlng = marker.getLatLng();
                latInput.value = latlng.lat.toFixed(6);
                lngInput.value = latlng.lng.toFixed(6);
            });

            map.on('click', function (e) {
                marker.setLatLng(e.latlng);
                latInput.value = e.latlng.lat.toFixed(6);
                lngInput.value = e.latlng.lng.toFixed(6);
            });
        }

        // Obtener ubicaci√≥n actual
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('latitud').value = lat.toFixed(6);
                        document.getElementById('longitud').value = lng.toFixed(6);

                        if (map) {
                            map.setView([lat, lng], 13);
                            marker.setLatLng([lat, lng]);
                        }
                    },
                    function (error) {
                        alert(
                            'No se pudo obtener tu ubicaci√≥n. Por favor, selecciona manualmente en el mapa. Error: ' +
                                error.message
                        );
                    }
                );
            } else {
                alert('Geolocalizaci√≥n no soportada por este navegador. Selecciona manualmente en el mapa.');
            }
        }

        // Enviar pedido por WhatsApp
        function submitOrder() {
            const orderDate = document.getElementById('orderDate').value;
            const address = document.getElementById('address').value.trim();
            const latitude = document.getElementById('latitud').value;
            const longitude = document.getElementById('longitud').value;
            const clientName = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;

            // Validaciones b√°sicas
            if (
                !orderDate ||
                !address ||
                !latitude ||
                !longitude ||
                !clientName ||
                !phone ||
                !paymentMethod
            ) {
                alert('Por favor, completa todos los campos obligatorios y selecciona una ubicaci√≥n.');
                return;
            }

            if (orders.length === 0) {
                alert('No has seleccionado productos para tu pedido.');
                return;
            }

            const total = orders.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0).toFixed(2);
            const hasGomitas = orders.some(item => item.category === 'gomitas');
            const hasCharola = orders.some(item => item.category === 'charola');
            const hasMiniHotcakes = orders.some(item => item.category === 'mini_hotcakes');
            const hasFresas = orders.some(item => item.category === 'fresas');
            const hasExtras = orders.some(item => item.category === 'extras');
            let productDetails = '';

            if (hasCharola) {
                const charolaItem = orders.find(item => item.category === 'charola');
                const charolaType = charolaItem?.type || charolaItem?.variety || 'No especificado';
                const gomitasType = orders.find(item => item.category === 'gomitas')?.variety || 'No especificado';

                productDetails += `Charola (${charolaType}, Gomitas: ${gomitasType})`;
            } else if (hasGomitas && !hasCharola) {
                const gomitasType = orders.find(item => item.category === 'gomitas')?.variety || 'No especificado';
                productDetails += `Bolsa de gomitas (${gomitasType})`;
            }
            if (hasMiniHotcakes) {
                productDetails += `${productDetails ? '\n' : ''}Mini Hotcakes`;
            }
            if (hasFresas) {
                productDetails += `${productDetails ? '\n' : ''}Fresas con crema`;
            }
            if (hasExtras) {
                const extras = orders.filter(item => item.category === 'extras').map(item => item.name).join(', ');
                productDetails += `${productDetails ? '\n' : ''}Extras: ${extras}`;
            }

            // Mensaje WhatsApp
            const message = `Hola, me gustar√≠a hacer un pedido:%0A` +
                `*Fecha de entrega:* ${orderDate}%0A` +
                `*Direcci√≥n:* ${address}%0A` +
                `*Ubicaci√≥n:* https://www.google.com/maps?q=${latitude},${longitude}%0A` +
                `*Nombre:* ${clientName}%0A` +
                `*Tel√©fono:* ${phone}%0A` +
                `*M√©todo de pago:* ${paymentMethod}%0A` +
                `*Productos seleccionados:*%0A${productDetails.replace(/\n/g, '%0A')}%0A` +
                `*Total:* $${total}`;

            // N√∫mero WhatsApp (el tuyo)
            const whatsappNumber = "524481012425";
            const url = `https://wa.me/${whatsappNumber}?text=${message}`;

            // Mostrar resumen
            const orderSummary = document.getElementById('orderSummary');
            orderSummary.style.display = 'block';
            orderSummary.innerHTML =
                `<p><strong>Resumen de tu pedido:</strong></p>` +
                `<p>Fecha de entrega: ${orderDate}</p>` +
                `<p>Direcci√≥n: ${address}</p>` +
                `<p>Nombre: ${clientName}</p>` +
                `<p>Tel√©fono: ${phone}</p>` +
                `<p>M√©todo de pago: ${paymentMethod}</p>` +
                `<p>Productos seleccionados:<br>${productDetails.replace(/\n/g, '<br>')}</p>` +
                `<p><strong>Total: $${total}</strong></p>` +
                `<p><a href="${url}" target="_blank" style="color: #4caf50;">Enviar pedido por WhatsApp</a></p>`;

            // Aqu√≠ puedes limpiar pedidos guardados o no, seg√∫n prefieras
            // localStorage.removeItem('orders');
            // orders = [];
            // updateOrderList();
        }

        // Toggle men√∫ para m√≥vil
        document.querySelector('.menu-toggle').addEventListener('click', () => {
            document.querySelector('.nav-menu').classList.toggle('active');
        });
    </script>
</body>
</html>